
from flask import Flask, render_template, request, redirect, url_for, session, flash
from flask_bcrypt import Bcrypt
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user
import mysql.connector
import re

app = Flask(__name__)
app.secret_key = 'your_secret_key'  # Change this for security
bcrypt = Bcrypt(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# Database connection
db_config = {
           'host':'localhost',
            'user':'root',
            'password':'',  # Your MySQL password
            'database':'krishi_kaushal'  # Database name
}

def get_db_connection():
    try:
        conn = mysql.connector.connect(**db_config)
        return conn 
    except mysql.connector.Error as err:
        print(f"Error: {err}")
        return None


@login_manager.user_loader
def load_user(user_id):

    try:
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
        user = cursor.fetchone()
        conn.close()
        if user:
            return User(user['id'], user['fullname'], user['email'])
    except Exception as e:
        print("Error loading user:", e)
    return None

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/')
def main():
    return render_template('main.html')

@app.route('/signup', methods=['GET','POST'])
def signup():
    if request.method == 'POST':
        fullname = request.form['fullname']
        email = request.form['email']
        phone = request.form['phone']
        password = request.form['password']

        # Backend Validation
        if not re.match(r"^[a-zA-Z\s]+$", fullname):  # Validate name (letters only)
            flash("Full Name should only contain letters!", "danger")
            return redirect(url_for('signup'))

        if not re.match(r"^[0-9]{10}$", phone):  # Validate phone (exactly 10 digits)
            flash("Phone number must be 10 digits!", "danger")
            return redirect(url_for('signup'))

        if not re.match(r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$", email):  # Validate email
            flash("Invalid email format!", "danger")
            return redirect(url_for('signup'))

        # Check if email already exists in the database
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT * FROM users WHERE email= %s", (email,))
        existing_user = cursor.fetchone()
        if existing_user:
            flash("Email is already registered! Please login.", "danger")
            conn.close()
            return redirect(url_for('login'))

        # Password Validation (optional, can be extended to more complexity)
        if len(password) < 6:
            flash("Password must be at least 6 characters long!", "danger")
            return redirect(url_for('signup'))

        # Secure password handling (hash password before storing)
        hashed_password = bcrypt.generate_password_hash(password).decode('utf-8')

        # Insert new user into the database
        try:
            cursor.execute("INSERT INTO users (fullname, email, phone, password_hash) VALUES ('"+fullname+"', '"+email+"', '"+phone+"', '"+hashed_password+"')" )
            conn.commit()
            flash("Signup successful! Please login.", "success")
            return redirect(url_for('login'))
        except Exception as e:
            flash(f"Error: {str(e)}", "danger")
        finally:
            cursor.close()
            conn.close()

    return render_template('signup.html')
    

@app.route('/login', methods=['GET', 'POST'])

def login():
    if request.method == 'POST':
        email = request.form['username']  # Username is actually email
        password = request.form['password']

        # Validate the input fields
        if not email or not password:
            flash("Email and Password are required!", "danger")
            return redirect(url_for('login'))

        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT * FROM users WHERE email = %s", (email,))
        user = cursor.fetchone()
        cursor.close()
        conn.close()

        # Check if the user exists and if the password matches
        if user and bcrypt.check_password_hash(user['password_hash'], password):
            # Log in the user
            user_obj = User(user['id'], user['fullname'], user['email'])
            login_user(user_obj)
            flash("Login successful!", "success")
            return redirect(url_for('dashboard'))
        else:
            flash("Invalid credentials. Please check your email and password.", "danger")

    return render_template('login.html')

@app.route('/')
def index():
    return render_template('rental_form.html')

@app.route('/')
def index():
        return redirect(url_for('index'))

    except Exception as e:
        flash(f"An error occurred: {e}", "danger")
        return redirect(url_for('index'))

@app.route('/dashboard')
@login_required
def dashboard():
    return render_template('dashboard.html', user=current_user)

@app.route('/logout')
@login_required
def logout():
    logout_user()
    flash("Logged out successfully!", "info")
    return redirect(url_for('login'))

@app.route('/rental-form')
def rental_form():
    return render_template('rental_form.html') 

@app.route('/equipments')
def equipments():
    return render_template('equipments.html')

@app.route('/about')
def about():
    return render_template('about.html')

@app.route('/contact')
def contact():
    return render_template('contact.html')

@app.route('/info/boom_sprayer')
def boom_sprayer_info():
    return render_template('Info/BoomSprayerInfo.html')

@app.route('/info/box_blade')
def box_blade_info():
    return render_template('Info/BoxBladeInfo.html')

@app.route('/info/combine_harvester')
def combine_harvester_info():
    return render_template('Info/CombineharvesterINFO.html')

@app.route('/info/driller')
def driller_info():
    return render_template('Info/DrillerInfo.html')

@app.route('/info/drone')
def drone_info():
    return render_template('Info/DroneInfo.html')

@app.route('/info/farm_tractor')
def farm_tractor_info():
    return render_template('Info/FarmTractorInfo.html')

@app.route('/info/fertilizer_spreader')
def fertilizer_spreader_info():
    return render_template('Info/FertilizerspreaderInfo.html')

@app.route('/info/hay_rake')
def hay_rake_info():
    return render_template('Info/HayRakeInfo.html')

@app.route('/info/heavy_tractor')
def heavy_tractor_info():
    return render_template('Info/HeavyTractorInfo.html')

@app.route('/info/hydraulic_harrow')
def hydraulic_harrow_info():
    return render_template('Info/hydraulic-harrowInfo.html')

@app.route('/info/landscape_rake')
def landscape_rake_info():
    return render_template('Info/LandscaperakeInfo.html')

@app.route('/info/leveler')
def leveler_info():
    return render_template('Info/LevelerInfo.html')

@app.route('/info/mini_power_tiller')
def mini_power_tiller_info():
    return render_template('Info/MiniPowerTillerInfo.html')

@app.route('/info/multi_crop_harvester')
def multi_crop_harvester_info():
    return render_template('Info/MulticropharvesterInfo.html')

@app.route('/info/paddy_field_tractor')
def paddy_field_tractor_info():
    return render_template('Info/PaddyFieldTractorInfo.html')

@app.route('/info/plow')
def plow_info():
    return render_template('Info/PlowInfo.html')

@app.route('/info/pneumatic_planter')
def pneumatic_planter_info():
    return render_template('Info/Pneumatic-planterInfo.html')

@app.route('/info/post_hole_digger')
def post_hole_digger_info():
    return render_template('Info/PostHoleDigger.html')

@app.route('/info/regular_tractor')
def regular_tractor_info():
    return render_template('Info/RegularTractorInfo.html')

@app.route('/info/ripper')
def ripper_info():
    return render_template('Info/RipperInfo.html')

@app.route('/info/rotary_cutter')
def rotary_cutter_info():
    return render_template('Info/Rotarycutter.html')

@app.route('/info/rotary_mulcher')
def rotary_mulcher_info():
    return render_template('Info/RotarymulcherInfo.html')

@app.route('/info/row_crop_tractor')
def row_crop_tractor_info():
    return render_template('Info/RowCropTractorInfo.html')

@app.route('/info/seeder')
def seeder_info():
    return render_template('Info/SeederInfo.html')

@app.route('/info/square_baler')
def square_baler_info():
    return render_template('Info/Squarebaler.html')

@app.route('/info/sub_soiler')
def sub_soiler_info():
    return render_template('Info/SubSoilersInfo.html')

@app.route('/info/sugar_cane_loader')
def sugar_cane_loader_info():
    return render_template('Info/SugarcaneloaderInfo.html')

@app.route('/info/utility_tractor')
def utility_tractor_info():
    return render_template('Info/UtilityTractorInfo.html')

@app.route('/info/zero_till')
def zero_till_info():
    return render_template('Info/ZeroTill.html')



if __name__ == '__main__':
    app.run(debug=True)
